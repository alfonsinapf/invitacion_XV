<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invitación XV - Spotify</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    button { padding: 0.5rem 1rem; margin: 0.5rem 0; }
    #authStatus { margin-bottom: 1rem; }
    .status-success { color: green; }
    .status-error { color: red; }
    #results li { cursor: pointer; }
  </style>
</head>
<body>

<h1>Playlist de Invitación XV</h1>

<div id="authSection">
  <button id="connectBtn">Conectar a Spotify</button>
  <div id="authStatus"></div>
</div>

<div id="searchSection" style="display:none;">
  <input type="text" id="searchInput" placeholder="Buscar canción..." />
  <ul id="results"></ul>
</div>

<h2>Playlist</h2>
<iframe id="playlistIframe" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>

<script>
  const CLIENT_ID = 'ba9385bd54cc4ba3b297ce5fca852fd9';
  const REDIRECT_URI = 'https://invitacion-xv-seven.vercel.app/';
  let accessToken = null;
  let refreshToken = null;
  let addedTracks = new Set();

  const authStatus = document.getElementById('authStatus');
  const searchSection = document.getElementById('searchSection');
  const results = document.getElementById('results');
  const playlistIframe = document.getElementById('playlistIframe');

  document.getElementById('connectBtn').addEventListener('click', () => {
    const scopes = encodeURIComponent('playlist-modify-public playlist-modify-private');
    const authURL = `https://accounts.spotify.com/authorize?response_type=code&client_id=${CLIENT_ID}&scope=${scopes}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
    window.location.href = authURL;
  });

  async function exchangeToken(code, isRefresh=false) {
    try {
      const res = await fetch('/api/exchange-token.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(isRefresh ? { refresh: code } : { code })
      });
      const data = await res.json();
      if (data.access_token) {
        accessToken = data.access_token;
        if (!isRefresh && data.refresh_token) refreshToken = data.refresh_token;
        authStatus.textContent = 'Conectado a Spotify';
        authStatus.className = 'status-success';
        showSearchSection();
        scheduleTokenRefresh(data.expires_in);
      } else {
        authStatus.textContent = 'Error al conectar con Spotify';
        authStatus.className = 'status-error';
        console.error(data);
      }
    } catch (err) {
      authStatus.textContent = 'Error en la comunicación con el servidor';
      authStatus.className = 'status-error';
      console.error(err);
    }
  }

  function scheduleTokenRefresh(expiresIn) {
    setTimeout(() => {
      if (refreshToken) exchangeToken(refreshToken, true);
    }, (expiresIn - 60) * 1000);
  }

  function showSearchSection() {
    searchSection.style.display = 'block';
  }

  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  if (code) exchangeToken(code);

  document.getElementById('searchInput').addEventListener('input', async (e) => {
    const query = e.target.value.trim();
    if (!query || !accessToken) return results.innerHTML = '';
    try {
      const res = await fetch('/api/search.mjs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query, accessToken })
      });
      const data = await res.json();
      results.innerHTML = '';
      data.tracks.items.forEach(track => {
        const li = document.createElement('li');
        li.textContent = `${track.name} - ${track.artists.map(a=>a.name).join(', ')}`;
        li.dataset.uri = track.uri;
        li.addEventListener('click', () => addToPlaylist(track.uri));
        results.appendChild(li);
      });
    } catch(err) { console.error(err); }
  });

  async function addToPlaylist(uri) {
    if (addedTracks.has(uri)) return alert('Canción ya agregada!');
    try {
      const res = await fetch('/api/add-to-playlist.mjs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ accessToken, trackUri: uri })
      });
      const data = await res.json();
      if (data.success) {
        addedTracks.add(uri);
        updatePlaylistIframe(data.playlistId);
      } else {
        alert('Error al agregar canción');
      }
    } catch(err) { console.error(err); }
  }

  function updatePlaylistIframe(playlistId) {
    playlistIframe.src = `https://open.spotify.com/embed/playlist/${playlistId}`;
  }
</script>
</body>
</html>
